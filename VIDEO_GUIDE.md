# 视频直播功能使用指南

## 功能概述

已完成的功能：
1. ✅ **陪伴状态前置** - 在实时监控标签页最上方显示陪伴状态
2. ✅ **视频直播后端** - 支持循环播放本地视频文件作为直播源
3. ✅ **视频直播前端** - 实时显示机器狗摄像头画面
4. ✅ **视频控制面板** - 启动/停止直播、选择视频源

## 快速开始

### 1. 准备测试视频

**方法一：使用脚本创建测试视频**
```bash
cd dog
python create_test_video.py
```

**方法二：使用自己的视频文件**
- 将视频文件（.mp4, .avi, .mov 等）复制到 `dog/assets/videos/` 目录

### 2. 启动后端服务器

```bash
cd dog
python dog_server.py
```

服务器将在 `http://localhost:5000` 启动

### 3. 运行 Flutter 应用

```bash
flutter run
```

### 4. 使用视频直播功能

1. 打开应用后，点击底部导航栏的"监控"
2. 切换到"视频"标签页
3. 从下拉菜单选择要播放的视频文件
4. 点击"启动直播"按钮
5. 视频将开始循环播放，模拟机器狗摄像头实时画面

## API 接口说明

### 视频相关 API

**获取可用视频列表**
```
GET /get_available_videos
Response: {
  "videos": [
    {"filename": "test_video.mp4", "size": 1234567, "available": true}
  ],
  "count": 1
}
```

**启动视频直播**
```
POST /start_video_stream
Body: {"video_filename": "test_video.mp4"}
Response: {"message": "视频直播已启动", "video": "test_video.mp4"}
```

**停止视频直播**
```
POST /stop_video_stream
Response: {"message": "视频直播已停止"}
```

**获取直播状态**
```
GET /get_stream_status
Response: {
  "is_streaming": true,
  "video_file": "path/to/video.mp4",
  "timestamp": "2026-01-02T10:00:00"
}
```

**视频流端点**
```
GET /video_feed
返回: MJPEG 流 (multipart/x-mixed-replace)
```

## 技术实现

### 后端（Python + Flask + OpenCV）

- **视频读取**: 使用 OpenCV 读取本地视频文件
- **循环播放**: 视频播放到结尾后自动重新开始
- **流式传输**: 使用 MJPEG 格式进行流式传输
- **帧率控制**: 约 30 FPS，保证流畅播放

### 前端（Flutter）

- **网络图片组件**: 使用 `Image.network` 显示 MJPEG 流
- **状态管理**: 管理直播开启/关闭状态
- **控制面板**: 提供视频选择和播放控制
- **错误处理**: 完善的加载和错误提示

## UI 布局

### 实时监控标签页
```
┌─────────────────────────────┐
│  陪伴状态 (前置)             │
│  ● 陪伴在患者身边            │
│  最后更新: 2026-01-02 10:00  │
├─────────────────────────────┤
│  患者活动情况图表            │
│  (过去24小时活动曲线)        │
├─────────────────────────────┤
│  机器狗位置                  │
│  位置: 客厅                  │
│  坐标: 31.2431, 121.4731    │
└─────────────────────────────┘
```

### 视频标签页
```
┌─────────────────────────────┐
│  机器狗摄像头直播            │
│  ┌───────────────────────┐  │
│  │                       │  │
│  │   [视频画面显示区]     │  │
│  │                       │  │
│  └───────────────────────┘  │
├─────────────────────────────┤
│  直播控制                    │
│  视频源: [test_video.mp4 ▼] │
│  [▶ 启动直播] [⏹ 停止直播]  │
│  ● 直播中...                │
└─────────────────────────────┘
```

## 注意事项

1. **视频格式**: 建议使用 MP4 格式，编码为 H.264
2. **视频大小**: 建议视频分辨率不超过 1280x720，以保证流畅播放
3. **网络连接**: 确保 Flutter 应用能访问 `http://localhost:5000`
4. **性能优化**: 视频会循环播放，长时间运行不会导致内存泄漏

## 故障排除

### 问题：无法启动直播
- 检查视频文件是否存在于 `dog/assets/videos/` 目录
- 确认后端服务器已启动
- 查看后端日志是否有错误信息

### 问题：视频无法显示
- 检查网络连接是否正常
- 确认视频格式是否支持
- 尝试重新启动后端服务器

### 问题：视频卡顿
- 降低视频分辨率
- 检查系统资源占用
- 确保没有其他程序占用大量带宽

## 依赖项

### Python 依赖
- flask
- flask-cors
- opencv-python

### Flutter 依赖
- http: ^0.13.6
- fl_chart: ^0.68.0

## 未来扩展

可以考虑的功能增强：
- [ ] 支持多个摄像头切换
- [ ] 添加录制功能
- [ ] 支持双向语音通话
- [ ] 添加云端存储支持
- [ ] 集成人脸识别和行为分析
